<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
    
<mapper namespace="Login">
	<select id="_00001" resultType="com.rest.api.object.WebAccount">
		SELECT Name, NRIC, CompanyRole FROM Users WHERE Name = #{Name} AND NRIC = #{NRIC}
	</select>
	
	<select id="_00002" resultType="com.rest.api.object.Company">
		SELECT A.Name AS CompanyName, A.UEN, A.TypeOfWork, COUNT(B.Name) AS EmployeeOnProject
		FROM EPASS.Company AS A
		LEFT JOIN Users AS B
		ON A.UEN = B.Company
		WHERE A.Name LIKE CONCAT('%',#{Name},'%')
		AND A.UEN LIKE CONCAT('%',#{UEN},'%')
		AND A.TypeOfWork LIKE CONCAT('%',#{TypeOfWork},'%')
		GROUP BY A.Name
	</select>
	
	<delete id="_0003">
		DELETE FROM Company WHERE UEN = #{UEN}
	</delete>
	
	<update id="_0004">
		UPDATE Company SET CompanyName = #{CompanyName}, TypeOfWork = #{TypeOfWork} WHERE UEN = #{UEN}
	</update>
	
	<insert id="_0005">
		INSERT INTO Company values(#{Name}, #{UEN}, #{TypeOfWork})
	</insert>
	
	<select id="_0006" resultType="com.rest.api.object.User">
		SELECT PassNo, A.Name, MobileNumber, Occupation, Email, NRIC, Category, B.Name AS Company, DateOfSIC, Nationality, 
		(
		CASE
			WHEN A.CompanyRole = 0 THEN "Admin"
			WHEN A.CompanyRole = 1 THEN "Sub Admin"
			WHEN A.CompanyRole = 2 THEN "Standard"
		END
		) AS CompanyRole, 
		(
		CASE
			WHEN A.CSOC = 0 THEN "No"
			WHEN A.CSOC = 1 THEN "Yes"
		END
		)AS CSOC, ExpireDate, Remark, AdditionalCourse, DateOfCourseFrom, DateOfCourseTo, Picture
		FROM Users AS A
		JOIN Company AS B
		ON A.Company = B.UEN
		WHERE B.Name IN
		<foreach item="item" collection="CompanyList" index="index" open="(" separator="," close=")">
			#{item}
		</foreach>
		AND NRIC LIKE CONCAT('%',#{NRIC},'%')
		AND A.Name LIKE CONCAT('%',#{Name},'%')
	</select>
	
	<delete id="_0007">
		DELETE FROM Users WHERE PassNo = #{PassNo}
	</delete>
	
	<insert id="_0008">
		INSERT INTO Users VALUES
		(NULL,
		#{Name},
		#{MobileNumber},
		#{Occupation},
		#{Email},
		#{NRIC},
		#{Category},
		#{Company},
		#{DateOfSIC},
		#{Nationality},
		${CompanyRole},
		${CSOC},
		#{ExpireDate},
		#{Remark},
		#{AdditionalCourse},
		#{DateOfCourseFrom},
		#{DateOfCourseTo},
		NULL);
	</insert>
	
	<update id="_0009">
		UPDATE Users SET Picture = #{Picture} WHERE NRIC = #{NRIC}
	</update>
	
	<update id="_0010">
		UPDATE Users SET
		Name = #{Name},
		MobileNumber = #{MobileNumber},
		Occupation = #{Occupation},
		Email = #{Email},
		NRIC = #{NRIC},
		Category = #{Category},
		Company = #{Company},
		DateOfSIC = #{DateOfSIC},
		Nationality = #{Nationality},
		CompanyRole = ${CompanyRole},
		CSOC = ${CSOC},
		ExpireDate = #{ExpireDate},
		Remark = #{Remark},
		AdditionalCourse = #{AdditionalCourse},
		DateOfCourseFrom = #{DateOfCourseFrom},
		DateOfCourseTo = #{DateOfCourseTo}
		WHERE PassNo = #{PassNo}
	</update>
	
	<select id="_0011" resultType="com.rest.api.object.User">
		SELECT PassNo, A.Name, MobileNumber, Occupation, Email, NRIC, Category, B.Name AS Company, DateOfSIC, Nationality, 
		(
		CASE
			WHEN A.CompanyRole = 0 THEN "Admin"
			WHEN A.CompanyRole = 1 THEN "Sub Admin"
			WHEN A.CompanyRole = 2 THEN "Standard"
		END
		) AS CompanyRole, 
		(
		CASE
			WHEN A.CSOC = 0 THEN "No"
			WHEN A.CSOC = 1 THEN "Yes"
		END
		)AS CSOC, ExpireDate, Remark, AdditionalCourse, DateOfCourseFrom, DateOfCourseTo, Picture FROM Users AS A
		JOIN Company AS B
		ON A.Company = B.UEN
		WHERE PassNo = #{PassNo}
	</select>
	
	<insert id="_0012">
		INSERT INTO Files VALUES(NULL, ${Category}, #{FileName}, #{Data}, #{User});
	</insert>
	
	<select id="_0013" resultType="com.rest.api.object.File">
		SELECT Idx, Category, OriginalFileName AS FileName, `User` FROM Files WHERE User = #{NRIC}
	</select>
	
	<select id="_0014" resultType="com.rest.api.object.File">
		SELECT Data FROM Files WHERE Idx = ${Idx}
	</select>
	
	<delete id="_0015">
		DELETE FROM Files WHERE User = (SELECT NRIC FROM Users WHERE PassNo = #{PassNo})
	</delete>
</mapper>